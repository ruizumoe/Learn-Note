# 表面位移

在上一章节完成曲面细分以后，我们只是获得了平摊表面下的多个顶点，增加这些定义后的一个比较大的用处就是结合位移贴图或法线贴图更加表面细节，一般在LOD0的情况下使用。

由于曲面细分可以在特定情况下使用，因此可以保证在原始模型为低模的时候，也能在在近距离提高模型精度。

一般来说位移贴图都是在曲面细分阶段的域着色器上采样并使用。该阶段会根据新顶点的在原三角形中的重心获得相关数据，从而生成新的顶点信息，此时采样位移贴图作为定点的偏移量，就能得到一个更好的细节效果。

## 位移贴图和视差贴图的区别

### 位移贴图
位移贴图是在有足够多的顶点的情况下，让表面展现更丰富的外形轮廓，其本身不创造细节，而是将细节放大。在一些动态变形（雪地、脚印）、有机体平滑、需要完美轮廓的静态高细节的场景下，可以选用位移贴图。
优点：
1. 曲面细分+唯一贴图能创建真实的几何体，得到的轮廓细节遮挡等都是真实的
2. 可以实现动态lod
3. 在实现动态地形变形（脚印和雪地）目前是唯一主流

缺点：
1. 性能开销大且不稳定：大量增加三角形数量，对GPU的几何处理能力是巨大考验。过度细分会严重降低帧率。
2. 容易出现裂纹（Cracking）：如果相邻面片的细分因子不同，在边界处可能因为位移计算不一致而产生裂缝，需要精心处理。
3. 需要高质量位移贴图：垃圾进，垃圾出。如果位移贴图质量差或有接缝，效果会很难看。


### 视差贴图

视差贴图主要发生在像素着色器节点，其本身并没有生成新的顶点和高度信息，只是通过将贴图在平面上进行位移，从而模拟出高度位置。

其有三个阶段

1. 视差映射
    + 原理：根据视角方向和高度值，对纹理坐标进行简单的偏移。
    + 缺点：当表面深度变化很大或视角很陡时，会出现严重的失真和纹理拉伸，因为它没有考虑遮挡关系。
2. 陡峭视差映射
    + 原理：它将高度图数值理解为一系列深度层。从表面开始，沿着视角方向步进（Step），每次步进都检查当前层的高度和采样高度图的高度。
    + 过程：就像深度探测。一旦发现采样到的高度图数值（即表面实际高度）比当前步进的深度层更“浅”（即更靠近表面），就说明我们穿过了表面。
    + 缺点：由于是离散的步进，会有锯齿感，效果看起来像一层一层的阶梯。
3. 视差遮蔽映射（POM）
    + 原理：在陡峭视差映射的基础上，找到穿越表面的那一步和上一步。然后在这两步之间进行线性插值，从而得到一个非常精确的、平滑的交叉点。
    + 结果：这个插值后的点，就是我们最终应该采样的新纹理坐标。它不仅模拟了深度，还正确地模拟了遮挡关系（远处的点会被近处的点挡住）。
    + 效果：POM的效果非常出色，在多数情况下足以“以假乱真”，让人以为是真正的几何细节。性能开销是像素着色器中的多次纹理采样（通常是10-20次步进）。

详情请参考 [chap20 Parallax](../Rendering/chap20%20Parallax.md) 的光线步进章节内容。

优点：
1. 性能开销低
2. 效果出色
3. 无需硬件支持，只需要像素着色器支持即可

缺点：
1. 不改变轮廓，从侧方向看就会穿帮
2. 不产生自遮挡阴影，只能通过技巧去模拟阴影
3. 依赖视角和UV，在UV扭曲或视角极度倾斜的表面可能失效。




