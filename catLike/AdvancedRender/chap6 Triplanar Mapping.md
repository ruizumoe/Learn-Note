# 三平面映射

## 基本介绍

### 概念

三平面映射是一种高级的纹理映射技术，用于为3D模型（尤其是复杂或不规则的表面）应用纹理，而无需依赖传统的UV坐标。

传统纹理映射的局限在于，纹理映射需要模型有良好的、不重叠的UV坐标。对简单的模型可行，但是当模型是基于程序生成的复杂模型时，容易在极点处出现拉伸或扭曲。

三平面映射的核心思想：它完全摒弃了模型的UV。相反，它沿着世界坐标系或物体坐标系的三个主轴（X, Y, Z）分别将纹理投影到模型表面上。

+ X轴平面（侧面）：从模型的左右两侧投影纹理。
+ Y轴平面（顶面）：从模型的顶部和底部投影纹理。
+ Z轴平面（前面）：从模型的前面和后面投影纹理。

然后，根据模型表面每个像素的法线向量，智能地混合这三个投影结果。法线指向哪个方向，就更多地采用那个方向的投影。

### 优势：

1. 消除纹理拉伸：这是它最核心的优势。由于纹理是从三个正交方向“投射”上去的，而不是“包裹”上去的，因此即使在极度崎岖或陡峭的表面上，也不会出现难看的拉伸。

2. 无缝平铺：当纹理设置为平铺模式时，三平面映射能创造出无限连续、无缝的表面细节，非常适合用于程序化生成的地形、岩石和建筑墙体。

3. 无需UV：对于程序化生成的网格（如Marching Cubes算法生成的地形、体素模型），可以实时生成而无需计算UV，大大简化了工作流程。

4. 易于实现纹理变化：你可以为顶面、侧面和正面使用完全不同的纹理。

    例如，在地形渲染中：
    + Y轴（顶面）投影：使用草地纹理。

    + X/Z轴（侧面）投影：使用岩石纹理。

这样就能根据表面的朝向自动生成非常自然的地貌。

### 缺点

1. 性能开销：相比传统UV采样一次，三平面映射需要采样三次纹理，并进行一次混合计算，对GPU的压力更大。

2. 接缝问题：在法线方向变化的过渡区域（如立方体的边缘），如果混合处理不当，可能会看到细微的接缝。但通过良好的实现可以很大程度上避免。

3. 不适用于需要精确UV的场合：例如，角色皮肤上的图案、衣服上的logo等需要精确定位的纹理，仍然必须使用传统的UV映射。


## 实现步骤（deepSeek描述）

核心步骤

1. 选择坐标空间

世界空间（World Space）：更常用。当物体在场景中移动时，纹理会“固定”在世界位置上，就像投影仪一样。适合地形等静态环境。

物体空间（Object Space）：纹理会附着在物体上，随着物体移动而移动。适合可移动的复杂道具。

以下以世界空间为例

2. 计算三个投影UV

对于模型表面的每个点，我们取其世界坐标（worldPos），并分别用不同的分量来生成UV。

+ 顶面投影（Y轴）：使用世界坐标的X和Z分量作为UV。`uv_top = worldPos.xz * _Scale`
+ 侧面投影（X轴）：使用世界坐标的Y和Z分量作为UV。`uv_side = worldPos.zy * _Scale`
+ 正面投影（Z轴）：使用世界坐标的X和Y分量作为UV。`uv_front = worldPos.xy * _Scale`

> _Scale是一个控制纹理平铺程度的属性。

3. 采样三次纹理

```glsl
fixed4 colX = tex2D(_MainTex, uv_side);
fixed4 colY = tex2D(_MainTex, uv_top);
fixed4 colZ = tex2D(_MainTex, uv_front);
```
4. 计算混合权重

权重基于该像素点的法线向量的绝对值。法线指向哪个方向越“正”，那个方向的投影权重就越高。

```glsl
float3 weights = abs(WorldNormalVector(IN, o.Normal)); // 获取世界空间法线并取绝对值
// 对权重进行归一化，确保它们的和为1
weights = weights / (weights.x + weights.y + weights.z);
```

> 例如，一个完全朝上的法线(0, 1, 0)，计算出的权重将是(0, 1, 0)，意味着最终颜色100%来自顶面投影。
>
> 一个45度朝向的法线(0.7, 0.7, 0)，权重经过归一化后大约是(0.5, 0.5, 0)。
5. 混合最终颜色

```glsl
fixed4 finalColor = colX * weights.x + colY * weights.y + colZ * weights.z;
```

### 进阶技巧

要让表面有凹凸细节，三平面映射同样可以支持法线贴图。但这更复杂，因为需要将三个投影采样到的法线（各自在不同的切线空间内）转换到统一的世界空间下再混合。

1. 采样三个法线：像采样颜色一样，采样三次法线贴图。
2. 构建三个切线空间到世界空间的矩阵：对于每个投影方向，都需要一个特定的转换矩阵。
3. 将法线转换到世界空间：将三个采样到的法线分别转换到世界空间。
4. 混合世界空间法线：使用同样的权重weights来混合这三个世界空间法线。
5. 使用混合后的法线：将混合后的法线用于最终的光照计算。

性能开销较大。
